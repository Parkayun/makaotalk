{% extends "base.html" %}

{% block title %}Chat - {{ chat_room.title }}{% endblock %}

{% block body %}
    <h1>Chat - {{ chat_room.title }}</h1>
    <div id="board">
    {% for message in messages %}
        <p id="message-{{ message.id }}">
            <span>{{ message.username }}: {{ message.text }}</span>
            {% if message.username == username %}
                -
                <button class="modify">modify</button>
                <button class="delete">Delete</button>
            {% endif %}
        </p>
    {% endfor %}
    </div>
    <input type="text" id="input">
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.min.js"></script>
    <script type="text/javascript" charset="utf-8">
    function getMessageIdByButton($button) {
        var $parent = $button.parent();
        return $parent.attr('id').replace('message-', '');
    }

    var username = '{{ username }}';
    var basicData = {username: username, room: '{{ chat_room.id }}'};
    var socket = io.connect('http://' + document.domain + ':' + location.port);

    socket.emit('join', basicData);

    socket.on('response', function(data) {
        var html = '<span>' + data['username'] + ': '+ data['message']['text'] + '</span>';
        if (data['username'] == username) {
            html += ' - <button class="delete">Delete</button>';
        }
        $('#board').append($('<p/>').html(html).attr('data-id', data['message']['id']));
    });

    socket.on('delete', function(data) {
        $('#message-'+data['message_id']).remove();
    });

    $('#input').keypress(function(event) {
       if (event.keyCode == 13) {
           var data = basicData;
           data['message'] = $(this).val();
           socket.emit('chat', data);
           $(this).val('');
       }
    });

    $('body').delegate('.delete', 'click', function(event) {
        var messageId = getMessageIdByButton($(this));
        var data = basicData;
        data['message_id'] = messageId
        socket.emit('delete', data);
    });

    $('body').delegate('.modify', 'click', function(event) {
        var messageId = getMessageIdByButton($(this));
    });
    </script>
{% endblock %}